---
title: "Investigating Vocational Teachers’ Workplace Learning: An Experience Sampling Approach to Karasek’s Learning Hypothesis"
author: "Manuel Böhm"
date: '`r Sys.Date()`'
output:
  html_document:
    toc: true
    toc_depth: '2'
    df_print: paged
  word_document: default
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 2
    keep_tex: TRUE
bibliography:
- _bib/references.bib
- _bib/grateful-refs.bib
csl: _bib/apa.csl
link-citations: true
toc: true
toc-title: Article Outline
header-includes: \pagenumbering{gobble}
numbersections: true
---

\newpage
\pagenumbering{arabic}



```{r}
# if any objects are available in the global environment, remove them
rm(list = ls())

```


```{r maintenance, eval=FALSE, include=FALSE}
source("_src/maintenance.R", local = knitr::knit_global())
```

```{r session start, include=FALSE}
## remove all objects
rm(list = ls())

## Load and install packages (using package manager)
if (!require("pacman")) {
  install.packages("pacman")
  library(pacman)
}
pacman::p_load(papaja, knitr, dplyr, remotes, lme4, tidyr, kableExtra,
               modelsummary, performance, stats, lmerTest, ggplot2, corrr,
               parameters, car, psych, jtools, grateful, blockTools,
               robustlmm, usethis, gitcreds, stringr, HLMdiag, lmtest, effects, 
               sjPlot, devtools, rmdwc, fastDummies, crosstable, fuzzyjoin, datawizard, forcats, wordcloud2, tm) 

# install.packages("robustlmm", dependencies = TRUE)
# install.packages("broom.mixed", dependencies = TRUE)

```

```{r load files, include=FALSE}
# welcome questionnaire
welcome_raw <- read.csv2("_data/raw/20221018_1718_1_AARL-BS Willkommen.csv")
# activities questionnaire
activities_raw <- read.csv2("_data/raw/20221018_1717_2_AARL-BS Taetigkeiten_de102944944440141306.csv")
# jobscope
jobscope <- read.csv2("_data/jobscope.csv", na = "?")
# jobscope correction
jobscope_correction <- read.csv2("_data/jobscope_v3.csv")

# zuordnung_new_task with activity names (12, 29, 3)
zuordnung_new_task <- read.csv2("_data/zuordnung_new_task.csv", 
                                 fileEncoding = "ISO-8859-1")

```

```{r data prep, include=FALSE}
source("_src/data_prep_welcome.R", local = knitr::knit_global())
source("_src/data_prep_activities.R", local = knitr::knit_global())
source("_src/data_prep_qualitative.R", local = knitr::knit_global())

#####
### format all datatypes appropriately! (see previous code (data_prep)) #####
#####
```

```{r}
# check combined_df for duplicates (in id)
# combined_df_duplicates <- combined_df %>%
#   group_by(id) %>%
#   mutate(n_entry = n()) %>%
#   ungroup() %>%
#   filter(n_entry > 1)

# combined_df_pre <- combined_df
```


```{r prepare combined_df with values from data_prep_qual & format data, include=FALSE}
# import into combined_df from df: task_no, task, sex, age, jobscope, duration
# combined_df$age <- welcome$age[match(combined_df$code, welcome$code)] #####

# update selected values in with values from df (manual data_prep)
# values: age, sex, jobscope, act_no, activity, duration

# Define your list of column names
# list <- c("age", "sex", "jobscope", "act_no", "activity", "duration")
list <- c("age", "sex", "jobscope", "act_no", "activity")
list_code <- c("age", "sex", "jobscope")
list_id <- c("act_no", "activity")

for (value in list_code) {
# Step 1
combined_df[[paste0(value, "_df")]] <- df[[value]][match(combined_df$code, df$code)]
}

for (value in list_id) {
combined_df[[paste0(value, "_df")]] <- df[[value]][match(combined_df$id, df$id)]
}

# Step 2
for (value in list){
  combined_df[[value]] <- ifelse(is.na(combined_df[[paste0(value, "_df")]]) | 
                                   is.na(match(combined_df$code, df$code)), 
    combined_df[[value]],                         
    combined_df[[paste0(value, "_df")]]           
  )
}

# LOGIC #####
# step 1 (simply transfer the values, keep all values from df)
# combined_df$age_df <- df$age[match(combined_df$code, df$code)]
# combined_df$act_no_df <- df$act_no[match(combined_df$id, df$id)]
# combined_df$activity_df <- df$activity[match(combined_df$code, df$id)]

# step 2
# age <- ifelse
# - age_df = NA OR 
# - no match

# then
# = age
# else
# age_df
##################

combined_df <- combined_df %>%
  select(-age_df, -sex_df, -jobscope_df, -act_no_df, -activity_df, -category)

```

```{r correction for learning outcomes, eval=FALSE}
#####
# Adjustments of data (format, corrections, ...)
#####

# remove all other activities (29) reporting illness
# create the dataframe sickness
df_sickness <- df %>%
  filter(krank_ == 1) %>%
  select(id, code, krank_)

combined_df$sickness <- 0
combined_df$sickness <- df_sickness$krank_[match(combined_df$id, df_sickness$id)]

# combined_df <- combined_df %>% 
#   filter(is.na(sickness))

# vacation
# reporting of vacation as activity -> remove these entries
combined_df <- combined_df %>%
  filter(!(str_detect(activity, "urlaub") | str_detect(activity, "Urlaub")))

# school holidays 
# reporting of school holiday as activity -> remove these entries
combined_df <- combined_df %>%
  filter(!(str_detect(activity, "ferien") | str_detect(activity, "oster") | str_detect(activity, "Oster")  | str_detect(activity, "Ferien") | str_detect(activity, "schulfrei")))

# weekend
# reporting of weekend as activity -> remove these entries
combined_df <- combined_df %>%
  filter(!str_detect(activity, "ochenende"))

# free day
# reporting of vacation as activity -> remove these entries
combined_df <- combined_df %>%
  filter(!(str_detect(activity, "frei") | str_detect(activity, "Freien Tag") | str_detect(activity, "eiertag")))
```

```{r}
###
# Selected Adjustments of data 
###

# remove additional reportings of sickness and vacation
# sickness
# reporting of sickness as activity -> remove these entries
combined_df <- combined_df %>%
  filter(!(str_detect(activity, "onstige") & 
           (str_detect(activity, "krank") | str_detect(activity, "Krank") | str_detect(activity, "corona") | str_detect(activity, "Corona")) &
           id != 20252 & id != 19836  & id != 48289 & id != 28568 & id != 4759))

# commuting between home and school
# reporting of commutes as activity -> remove these entries
combined_df <- combined_df %>%
  filter(!(str_detect(activity, "rbeitsweg") | str_detect(activity, "hause") | str_detect(activity, "Hause") | str_detect(activity, "zur Schule") | str_detect(activity, "Anreise") | str_detect(activity, "Heim")))

# other invalid entries --> remove these entries
combined_df <- combined_df %>%
  filter(!(str_detect(activity, "keine") | str_detect(activity, "Keine") | str_detect(activity, "mQuest") | str_detect(activity, "zeitstudie") | str_detect(activity, ": Hausarbeit") | id == 36469 | id == 49189 | id == 5081 | id == 4356 | id == 5417 | id == 17552))

##########
# correct categories
##########
# some of 29 belong to Aufsicht (9)
combined_df <- combined_df %>% 
  mutate(
    act_no = case_when(
      id == "35883" ~ 9,  # id = 35883 is Aufsicht
      str_detect(activity, "onstige") & 
      (str_detect(activity, "lausuraufsicht") | str_detect(activity, "rüfungsaufsicht") | str_detect(activity, "ufsicht Klassenarbeit")) ~ 9,
      TRUE ~ act_no  # Behalte den Originalwert bei, wenn keine Bedingung zutrifft
    ),
    activity = case_when(
      str_detect(activity, "onstige") & 
      (str_detect(activity, "lausuraufsicht") | str_detect(activity, "rüfungsaufsicht") | str_detect(activity, "ufsicht Klassenarbeit")) ~ "Aufsicht",
      TRUE ~ activity  # Behalte den Originalwert bei, wenn keine Bedingung zutrifft
    )
  )


combined_df <- combined_df %>%
  mutate(act_no = case_when(str_detect(activity, "onstige Tätigkeit") ~ 29, .default = act_no))

# combined_df_test <- combined_df %>%
#  filter(act_no == 29)

# combined_df_test <- combined_df %>%
#  filter(act_no == 9)
    
# correct coping
combined_df$coping <- ifelse(combined_df$stress == 0, 0, combined_df$coping)

# format data for analyses
combined_df <- combined_df %>% # Before: 1=w, 2=m; NOW: 0=w, 1=m
  mutate(sex = case_match(sex, 1 ~ 0, 2 ~ 1)
         )

# correct error: 
# change value of column act_no to 3 for entry with id = "45771"
combined_df$act_no[combined_df$id == "45771"] <- 5

# In combined_df in column activity, delete whitespace at the beginning and end of the string
combined_df$activity <- str_trim(combined_df$activity)

# adjust name of activity 9
combined_df <- combined_df %>%
  mutate(activity = ifelse(act_no == 9, "Aufsicht", activity))

# test
# table(combined_df$activity)
# table(combined_df$activity [combined_df$act_no == 9])
# table(combined_df$activity [combined_df$act_no != 29])
# table(combined_df$activity [combined_df$act_no == 20])
# table(combined_df$activity [combined_df$act_no == 9])

# compare number of cases (which were deleted?!)

# check other activity (29)
#combined_df_other <- combined_df %>%
#  filter(act_no == 29)


# combined_df <- combined_df %>% # adjust act_no 29
#  mutate(act_no = ifelse(category == 4, 29, act_no))


# insert English activity names
```

```{r insert 12-category names}
# rename columns in table zuordnung: neue_kategorie to activity_12, alte_kategorie to act_no
zuordnung_new_task <- zuordnung_new_task %>%
  rename(activity_12 = neue_kategorie,
         act_no = alte_kategorie)

combined_df <- combined_df %>%
  left_join(zuordnung_new_task %>% select(act_no, activity_12, taskname_new_en), by = "act_no")
```

```{r remove unnecessary columns and dataframes, include=FALSE}
rm(week_rv)
rm(weights_20)
rm(weights_fbs_20)
rm(jobscope)
rm(jobscope_correction)
rm(holidays)
rm(fbs_data)
rm(df_old)
```

```{r, eval=FALSE}
# check combined_df for duplicates (in id)
combined_df_duplicates <- combined_df %>%
  group_by(id) %>%
  mutate(n_entry = n()) %>%
  ungroup() # %>%
#   filter(n_entry > 1)

```

# Data Analysis / Results

## Overall data prep & check (descriptives & assumptions)

```{r}
colSums(is.na(combined_df))

psych::describe(combined_df)

```

## RQ1: Extent of percieved Learning across Vocational Teachers' Everyday Work Activities (--> aus bwpat)
- 12 activity categories


```{r rq1_analysis}
df_rq1 <- combined_df

df_rq1 %>%
  group_by(activity_12) %>%
  summarise(
    mean_learn = mean(pc_learn, na.rm = TRUE),
    sd_learn = sd(pc_learn, na.rm = TRUE),
    median_learn = median(pc_learn, na.rm = TRUE),
    n = n()
  )

```

```{r rq1_vis}
ggplot(df_rq1, aes(x = factor(activity_12), y = pc_learn)) +
  geom_boxplot() +
  labs(x = "Activity category", y = "Perceived learning (pc_learn)")
```

```{r}
ggplot(df_rq1, aes(x = factor(activity_12), y = pc_learn)) +
  geom_violin() +
  geom_boxplot(width = 0.1, outlier.shape = NA)

```

```{r}
df_rq1 %>%
  group_by(activity_12) %>%
  summarise(
    mean_learn = mean(pc_learn, na.rm = TRUE),
    se = sd(pc_learn, na.rm = TRUE)/sqrt(n())
  ) %>%
  ggplot(aes(x = factor(activity_12), y = mean_learn)) +
  geom_col() +
  geom_errorbar(aes(ymin = mean_learn - se, ymax = mean_learn + se), width = 0.2)

```

```{r}
df_rq1 %>%
  group_by(activity_12) %>%
  summarise(
    prop_zero = mean(pc_learn == 0, na.rm = TRUE)
  )

```

```{r, eval=FALSE}
kruskal.test(pc_learn ~ factor(activity_12), data = df_rq1)

rstatix::kruskal_effsize(df_rq1, pc_learn ~ factor(activity_12))

```


## RQ2: The Effect of Vocational Teachers' Everyday Work Activities on the Extent of their Perceived Learning (MLM regression)
/ What is the Effect of Vocational Teachers' Everyday Work Activities on the Extent of their Perceived Learning?
- stufenweise aufbauen
- include: 
-- learning outcome (pc_learn)
-- check for effects of activity (dummy variables) --> only if rq2 is significant
-- control variables (age, sex, jobscope)
-- check for effects of n_entry (number of entries per person)


```{r rq2_prep}

```

```{r rq2_analysis mlm}

```

## ----------

## RQ3: Comparison of Global and Situational Measures of Stress and Coping
/ To what extent do Situational measures of stress and coping correspond with global self-reports?
a) Stress
b) coping

```{r rq3_prep}

```

```{r rq3_analysis}

```


## RQ4: Predicting Vocational Teachers' Informal Learning Using Stress and Coping during their Everyday Work Activities (as stated in Karasek's Learning Hypothesis)
- stufenweise aufbauen
- include: 
-- learning outcome (pc_learn)
-- stress and coping as predictors (situational measures)
-- stress and coping as predictors (global measures)
-- interaction effect (stress*coping) global / situational?!
-- control variables (age, sex, jobscope)
(-- check for effects of activity (dummy variables) --> only if rq2 is significant) --> careful as stress and coping lie in these activities...
-- check for effects of n_entry (number of entries per person)

```{r rq4_prep}

```

```{r rq4_analysis mlm}

```


```{r filter data & prepare them, include=FALSE}
df_rq3 <- combined_df
df_rq3$act_no <- as.factor(df_rq3$act_no)

# standardize all variables

# df_rq3$pc_learn_z <- standardize(df_rq3$pc_learn)
df_rq3$stress_z <- standardize(df_rq3$stress)
df_rq3$coping_z <- standardize(df_rq3$coping)


# add dummy variables for act #####
df_rq3 <- dummy_cols(df_rq3, select_columns = "act_no")

```

```{r test all assumptions, include=FALSE}
# multicollinearity?!
# especially with the interaction term ... 
```

```{r correlations, include = FALSE}
# cor_tab <- cor(subset(variant1, select = c(task_routine:proc_learn)))

rq3_subset_cor <- subset(df_rq3, select = c(sex:jobscope, stress:pc_learn, n_entry, stress_z, coping_z))

# maybe add mean and sd

cor_tab_ <- rq3_subset_cor %>%
  # select(c(group_mlm:proc_learn)) %>%
  correlate() %>%
  shave(upper = TRUE) %>%
  fashion(decimals = 2, na_print = "—") 

cor_tab_$term <- paste(seq_len(nrow(cor_tab_)), ". ", cor_tab_$term, sep = "")
```

```{r rq3 corr_table_kable, echo=FALSE}
cor_tab_ %>%
  kable(
    caption = "Correlations between Variables RQ3",
    col.names = c("Measure", "1", "2", "3", "4", "5", "6", "7", "8", "9")
  )
```

```{r rq3 model 1, include=FALSE}
rq3_model1 <- lmerTest::lmer(data = df_rq3, pc_learn ~ 1 + (1|code), REML = T) 

# summary(rq3_model1)
```

```{r rq3 model 1 ICC, echo=FALSE}
# icc calculation
# icc(rq2_model1)
kable(table(round(icc(rq3_model1), 4)), caption = "ICC RQ3 (REML)")
```

```{r rq3 model 1 REML_F, include=FALSE}
rq3_model1 <- lmerTest::lmer(data = df_rq3, pc_learn ~ 1 + (1|code), REML = F) 
```

```{r rq3 model 2, include=FALSE}
# issue: act_no 29 not available

rq3_model2 <- lmerTest::lmer(data = df_rq3, pc_learn ~  sex + age + jobscope + stress_z + coping_z + stress_z*coping_z + n_entry + 
                               act_no_1 +  act_no_2 + 
                               act_no_3 +  act_no_4 +
                               act_no_5 +  act_no_6 + 
                               act_no_7 +  act_no_8 + 
                               act_no_9 +  act_no_10 + 
                               act_no_11 + act_no_12 + 
                               act_no_13 + act_no_14 + 
                               act_no_15 + act_no_16 + 
                               act_no_17 + act_no_18 + 
                               act_no_19 + act_no_20 +
                               act_no_21 + act_no_22 +
                               act_no_23 + act_no_24 +
                               act_no_25 + act_no_26 +
                               act_no_27 + act_no_28 + #act_no_29 + 
                               (1|code), REML = F) # + time + activity dummy variables

summary(rq3_model2)
```

```{r rq3 results table, echo=FALSE}
rq3_results_table <- modelsummary::msummary(list("Model 1" = rq3_model1, 
                                                 "Model 2" = rq3_model2), gof_omit = "ICC", stars = T, title = "Summary Multilevel Model RQ3", output = 'kableExtra', metrics = "all", statistic = c("std.error", "p.value", "conf.int"))

rq3_results_table %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

```{r rq3 kable, echo=FALSE}
# kable(rq3_model2, digits = 2, caption = "MLM of Informal Learning during Teachers' Work Activities ")
```

# References

::: {#refs custom-style="Bibliography"}
:::

\newpage

# Appendix

